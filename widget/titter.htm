<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>


<template id="titter-template">
    <div id="titter-id">
        <div class="col-md-7">
            <h2>Enter text in form below and press send</h2>
            <form method='POST' action="/sendComment" class="margin-bottom" role="form">
                <div class="form-group col-xs-12 has-error">
                    <textarea rows="3" class="form-control" placeholder="Type text to post on our page" name="comment" id="comment" onkeyup="createImage();"></textarea>
                    <div class="help-block"></div>
                </div>
                <div class="form-group col-xs-12">
                    <div class="pull-right">
                        <label class="comment-limit">10</label>
                        <button type="button" class="btn btn-primary" onclick="saveCanvas();"><span class="glyphicon glyphicon-ok"></span>Send</button>
                    </div>
                </div>
            </form>
        </div>
        <div>
            <h3 class="centertext">Image to post</h3>
            <div><canvas id="twitterPost" width="150" height="150" class="img-responsive canvascenter"></canvas></div>
            <h3 id="result" class="centertext"></h3>
        </div>
    </div>
</template>

<script>
    (function($){
        var importDoc = document.currentScript.ownerDocument;

        var template = importDoc.querySelector('#titter-template');
        var $template = $(template.innerHTML);

        var proto = Object.create(HTMLElement.prototype);
        proto.createdCallback = function() {
            this.outerHTML = $template.get(0).outerHTML;
        };
        document.registerElement('titter-widget', {prototype: proto});
    })(jQuery);
</script>

<script type="text/javascript">
    function createImage() {
        var canvas = document.getElementById('twitterPost');
        if (canvas.getContext) {
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = "18px Arial";
            ctx.fillText(document.getElementById('comment').value, 10, 30);
        }
        $("#twitterPost").show();
    }

    function saveCanvas() {
        createImage();
        var canvas = document.getElementById('twitterPost');
        var comment = document.getElementById('comment').value;
        var imageData = canvas.toDataURL('image/png');

        //dataType: 'json', removed because of ajax error
        $.ajax({
            url: 'http://titter.webrunes.com/sendComment',
            type: 'post',
            data: {
                'fileData': imageData,
                'comment': comment
            },


        }).done(function(data) {
            document.getElementById('comment').value = '';
            console.log("successfully sent");
            $('#result').html("Successfully sent!").removeClass("redError");

        }).fail(function(request,error) {
            console.log("Request: " + JSON.stringify(request));
            $('#result').html("Error while executing your request :(").addClass("redError");
        });

    }
</script>

<style type="text/css">

    .redError {
        color: red;
    }
    #twitterPost {
        border: 1px solid black;
        display: none;
        padding-left: 0;
        padding-right: 0;
        margin-left: auto;
        margin-right: auto;
        display: block;

    }
    .centertext {
        text-align: center;
    }

</style>
